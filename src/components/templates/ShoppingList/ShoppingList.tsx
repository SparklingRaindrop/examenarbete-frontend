import Head from 'next/head';
import { ChangeEvent, useEffect, useReducer } from 'react';
import { useGroceries } from '../../../hooks';
import { Button, Icon, List, Main } from '../../elements';
import GroceryItem from './blocks/GroceryItem';
import GroceryList from './blocks/GroceryList';

const mockGroceries: Grocery[] = [
    {
        id: '1',
        name: 'tomatoes',
        updated_at: new Date(1672774937044),
        amount: 1,
        item_id: '1',
        isChecked: false
    }, {
        id: '3',
        name: 'onions',
        updated_at: new Date(1672774937044),
        amount: 5,
        item_id: '2',
        isChecked: false
    }
];

type ActionType = 'check' | 'initial';
interface Action {
    type: ActionType;
    id?: string;
    checked?: boolean;
    data?: Grocery[] | undefined;
}

function reducer(state: Grocery[], action: Action): Array<Grocery> {
    const { type } = action;

    if (type === 'check') {
        const { checked, id } = action;
        if (typeof checked === 'undefined') {
            throw new Error('Missing required property.');
        }

        return state.map(item => {
            if (item.id === id) {
                item.isChecked = checked;
            }
            return item;
        });
    } else if (type === 'initial') {
        const { data } = action;
        if (typeof data === 'undefined') {
            throw new Error('Missing required property.');
        }
        return data;
    }
    return state;
}

export default function ShoppingList() {
    const [state, dispatch] = useReducer(reducer, []);
    const value = useGroceries();

    useEffect(() => {
        dispatch({
            type: 'initial',
            data: value?.groceries,
        });
    }, [value]);

    function toggleCheckbox(event: ChangeEvent<HTMLInputElement>, id: string) {
        const checked = event.target.checked;
        dispatch({
            id,
            type: 'check',
            checked,
        });
    }

    return (
        <>
            <Head>
                <title>Shopping List</title>
                <meta name="description" content="Generated by create next app" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <Main>
                <Button label='Generate' />
                <GroceryList state={state} toggleCheckbox={toggleCheckbox} />
                <Button
                    variant='ghost'
                    onClick={() => console.log('clicked')}>
                    <Icon name='plus' />
                    Add an Item
                </Button>
                <GroceryList state={state} toggleCheckbox={toggleCheckbox} crossed />
            </Main>
        </>
    );
}